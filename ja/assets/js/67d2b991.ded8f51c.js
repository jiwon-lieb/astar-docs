"use strict";(self.webpackChunkdocs_1=self.webpackChunkdocs_1||[]).push([[80],{52656:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>a,frontMatter:()=>t,metadata:()=>c,toc:()=>h});var o=s(85893),r=s(11151);const t={sidebar_position:2},i="2. Secure SSH Connection",c={id:"build/nodes/collator/secure_setup_guide/secure_connection",title:"2. Secure SSH Connection",description:"SSH access is the most standard attack vector for an online server. An incredible number of robots and hackers scan the default port 22 and gain access, with basic and elaborated credentials.",source:"@site/docs/build/nodes/collator/secure_setup_guide/secure_connection.md",sourceDirName:"build/nodes/collator/secure_setup_guide",slug:"/build/nodes/collator/secure_setup_guide/secure_connection",permalink:"/ja/docs/build/nodes/collator/secure_setup_guide/secure_connection",draft:!1,unlisted:!1,editUrl:"https://github.com/AstarNetwork/astar-docs/tree/main/docs/build/nodes/collator/secure_setup_guide/secure_connection.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"1. Create Your Environment",permalink:"/ja/docs/build/nodes/collator/secure_setup_guide/create_environnement"},next:{title:"3. SSH Tunneling",permalink:"/ja/docs/build/nodes/collator/secure_setup_guide/ssh_tunneling"}},d={},h=[{value:"Configuration",id:"configuration",level:2},{value:"Firewall",id:"firewall",level:3},{value:"Generate SSH keys",id:"generate-ssh-keys",level:3},{value:"Verify <a></a>",id:"verify-",level:3},{value:"Connect <a></a>",id:"connect-",level:3}];function l(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h1,{id:"2-secure-ssh-connection",children:"2. Secure SSH Connection"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"SSH access"})," is the most standard attack vector for an online server. An incredible number of robots and hackers scan the default port 22 and gain access, with basic and elaborated credentials."]}),"\n",(0,o.jsxs)(n.p,{children:["In this part, we are going to build a ",(0,o.jsx)(n.strong,{children:"secure SSH connection with strong SSH keys."})," We will ",(0,o.jsx)(n.strong,{children:"change the default SSH port"})," to mitigate scans and brute-force attempts."]}),"\n",(0,o.jsxs)(n.p,{children:["We will use the ",(0,o.jsx)(n.a,{href:"https://git.libssh.org/projects/libssh.git/tree/doc/curve25519-sha256@libssh.org.txt",children:(0,o.jsx)(n.code,{children:"curve25519-sha256"})})," protocol (",(0,o.jsx)(n.strong,{children:"ECDH over Curve25519 with SHA2"}),") for our keys here as this is considered the most secure nowadays."]}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsxs)(n.p,{children:["This part is a modified version of ",(0,o.jsx)(n.a,{href:"https://medium.com/bld-nodes/securing-ssh-access-to-your-server-cc1324b9adf6",children:"bLd's guide"})," using only ",(0,o.jsx)(n.strong,{children:"Putty"})," client to access server. If you are using Linux or MacOS, you can refer directly to the original guide to use ",(0,o.jsx)(n.strong,{children:"Open SSH"}),"."]})}),"\n",(0,o.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsx)(n.p,{children:"Follow this guide step-by-step. We recommend that you try to understand every step explained in this guide."})}),"\n",(0,o.jsx)(n.admonition,{type:"caution",children:(0,o.jsx)(n.p,{children:"Be very careful to never close your actual session until you\u2019ve tested the connection with your new key. You could lose access to your SSH connection."})}),"\n",(0,o.jsxs)(n.p,{children:["Connect to your server using ",(0,o.jsx)(n.a,{href:"https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html",children:"PuTTy"}),"."]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Open PuTTY"}),"\n",(0,o.jsxs)(n.li,{children:["Type the IP of your server on Azure in the field called \u2018",(0,o.jsx)(n.strong,{children:"Host Name"}),"\u2019."]}),"\n",(0,o.jsx)(n.li,{children:"The terminal will open and you can log in with your username and password."}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"Let\u2019s start by moving our actual unsecured host keys into a backup directory:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"cd /etc/ssh\nsudo mkdir backup\nsudo mv ssh_host_* ./backup/\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Open the ",(0,o.jsx)(n.code,{children:"ssh"})," config file:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"sudo nano /etc/ssh/ssh_config\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Add the following lines in the ",(0,o.jsx)(n.code,{children:"Host *"})," section and save:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"Host *\n    KexAlgorithms curve25519-sha256@libssh.org\n    HostKeyAlgorithms ssh-ed25519-cert-v01@openssh.com,ssh-ed25519\n    Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr\n    MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512,hmac-sha2-256,umac-128@openssh.com\n    PasswordAuthentication no\n    ChallengeResponseAuthentication no\n    PubkeyAuthentication yes\n    UseRoaming no\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Save ",(0,o.jsx)(n.code,{children:"CTRL+O"})," your file and close the editor ",(0,o.jsx)(n.code,{children:"CTRL+X"})]}),"\n",(0,o.jsxs)(n.p,{children:["Open the ",(0,o.jsx)(n.code,{children:"sshd"})," config file:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"sudo nano /etc/ssh/sshd_config\n"})}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsx)(n.p,{children:"In the following lines, you see that we use port 4321. This is just an example. You can use any random port within the range of 1024 to 49151. Copy these lines in your file:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"Port 22 \nPort 4321 \nKexAlgorithms curve25519-sha256@libssh.org \nHostKey /etc/ssh/ssh_host_ed25519_key \nCiphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr \nMACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512,hmac-sha2-256,umac-128@openssh.com \nAllowGroups ssh-user \nPubkeyAuthentication yes \nPasswordAuthentication no \nChallengeResponseAuthentication no\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Save ",(0,o.jsx)(n.code,{children:"CTRL+O"})," your file and close the editor ",(0,o.jsx)(n.code,{children:"CTRL+X"})," ."]}),"\n",(0,o.jsx)(n.p,{children:"Now, what did we just do? In detail, we told the host to:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Use the port  instead 4321 of default 22: please use a different random port in the range 1024\u201349151"}),"\n",(0,o.jsxs)(n.li,{children:["Use the ",(0,o.jsx)(n.code,{children:"curve25519"})," protocol for authentication"]}),"\n",(0,o.jsxs)(n.li,{children:["Use ",(0,o.jsx)(n.code,{children:"chacha20-poly1305"})," (preferred), ",(0,o.jsx)(n.code,{children:"aes-gmc"})," and ",(0,o.jsx)(n.code,{children:"aes-ctr"})," ciphers for data"]}),"\n",(0,o.jsxs)(n.li,{children:["Enable ",(0,o.jsx)(n.em,{children:"Message Authentication Code MAC"})," for CTR ciphers"]}),"\n",(0,o.jsx)(n.li,{children:"Allow ssh group ssh-user"}),"\n",(0,o.jsx)(n.li,{children:"Enable key authentication"}),"\n",(0,o.jsx)(n.li,{children:"Disable password access"}),"\n"]}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsxs)(n.p,{children:["Here we left the line ",(0,o.jsx)(n.code,{children:"Port 22"})," for the first test on the new port. Once your tests are successful, we will remove this line."]})}),"\n",(0,o.jsx)(n.p,{children:"Then, create the new SSH host key:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'sudo ssh-keygen -t ed25519 -f ssh_host_ed25519_key -N ""\n'})}),"\n",(0,o.jsx)(n.p,{children:"Create the SSH user group and add your user to it. This will prevent any connection to an unexpected user:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"sudo groupadd ssh-user\nsudo usermod -a -G ssh-user <username>\n"})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Note"}),": you have to change ",(0,o.jsx)(n.code,{children:"<username>"})," by the user that you use on your server."]}),"\n",(0,o.jsx)(n.h3,{id:"firewall",children:"Firewall"}),"\n",(0,o.jsx)(n.p,{children:"Before continuing, it is very important to open the newly configured SSH port in your firewall settings of your server (4321 in our example). For the first tests, you should let port 22 open. Once you successfully connected to the new port, you can safely close port 22."}),"\n",(0,o.jsx)(n.h3,{id:"generate-ssh-keys",children:"Generate SSH keys"}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsxs)(n.p,{children:["This guide is built around Azure and PuTTy, in case you want to use OpenSSH follow ",(0,o.jsx)(n.a,{href:"https://medium.com/bld-nodes/securing-ssh-access-to-your-server-cc1324b9adf6",children:"this guide"}),"."]})}),"\n",(0,o.jsx)(n.p,{children:"Open PUTTYGen GUI:"}),"\n",(0,o.jsx)("center",{children:(0,o.jsx)("img",{src:"https://i.imgur.com/rkef1ah.png",border:"1"})}),"\n",(0,o.jsxs)(n.p,{children:["Select the ",(0,o.jsx)(n.code,{children:"Ed25519"}),"key type and click on ",(0,o.jsx)(n.em,{children:"Generate"}),":"]}),"\n",(0,o.jsx)("center",{children:(0,o.jsx)("img",{src:"https://i.imgur.com/5kFNxJ6.png",border:"1"})}),"\n",(0,o.jsx)(n.p,{children:"Enter a strong passphrase and save both private and public key in a secure folder. Copy the public key from the text box."}),"\n",(0,o.jsxs)(n.p,{children:["Go back to the PuTTy session on your ",(0,o.jsx)(n.strong,{children:"server"})," and open the ",(0,o.jsx)(n.code,{children:"authorized_keys"})," file."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"sudo nano ~/.ssh/authorized_keys\n"})}),"\n",(0,o.jsx)(n.p,{children:"Paste the public key and save."}),"\n",(0,o.jsxs)(n.h3,{id:"verify-",children:["Verify ",(0,o.jsx)("a",{href:"#0f49",id:"0f49"})]}),"\n",(0,o.jsxs)(n.p,{children:["Let\u2019s restart the ",(0,o.jsx)(n.code,{children:"ssh"})," service without killing the current session:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"sudo kill -SIGHUP $(pgrep -f 'sshd -D')\n"})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Attention"}),": you should not send a complete restart of ",(0,o.jsx)(n.code,{children:"sshd"})," for the moment, this would close your open session and potentially lose access to your server if something is set wrong."]}),"\n",(0,o.jsxs)(n.p,{children:["Check that the ",(0,o.jsx)(n.code,{children:"sshd"})," service is still running correctly:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"systemctl status sshd\n"})}),"\n",(0,o.jsxs)(n.h3,{id:"connect-",children:["Connect ",(0,o.jsx)("a",{href:"#3255",id:"3255"})]}),"\n",(0,o.jsxs)(n.p,{children:["Let\u2019s load the private key in the Putty ",(0,o.jsx)(n.code,{children:"Auth"})," section:"]}),"\n",(0,o.jsx)("center",{children:(0,o.jsx)("img",{src:"https://i.imgur.com/vTtWZ0B.png",border:"1"})}),"\n",(0,o.jsx)(n.p,{children:"Don\u2019t forget to use your custom port, then connect:"}),"\n",(0,o.jsx)("center",{children:(0,o.jsx)("img",{src:"https://i.imgur.com/nLgoXNu.png",border:"1"})}),"\n",(0,o.jsxs)(n.p,{children:["Congratulation, y",(0,o.jsx)(n.strong,{children:"our SSH connection is secure"}),"! "]}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsxs)(n.p,{children:["Don\u2019t forget to remove port 22 from ",(0,o.jsx)(n.code,{children:"sshd_config"})," file and firewall, and check that no other key is allowed in ",(0,o.jsx)(n.code,{children:"authorized_keys"})," file."]})})]})}function a(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},11151:(e,n,s)=>{s.d(n,{Z:()=>c,a:()=>i});var o=s(67294);const r={},t=o.createContext(r);function i(e){const n=o.useContext(t);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),o.createElement(t.Provider,{value:n},e.children)}}}]);