"use strict";(self.webpackChunkdocs_1=self.webpackChunkdocs_1||[]).push([[2282],{66811:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>d,frontMatter:()=>a,metadata:()=>i,toc:()=>l});var t=r(85893),o=r(11151);const a={sidebar_position:5},s="Swap",i={id:"build/wasm/from-zero-to-ink-hero/dex/Pair/swap",title:"Swap",description:"If you are starting the tutorial from here, please check out this branch and open it in your IDE.",source:"@site/docs/build/wasm/from-zero-to-ink-hero/dex/Pair/swap.md",sourceDirName:"build/wasm/from-zero-to-ink-hero/dex/Pair",slug:"/build/wasm/from-zero-to-ink-hero/dex/Pair/swap",permalink:"/docs/build/wasm/from-zero-to-ink-hero/dex/Pair/swap",draft:!1,unlisted:!1,editUrl:"https://github.com/AstarNetwork/astar-docs/tree/main/docs/build/wasm/from-zero-to-ink-hero/dex/Pair/swap.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5},sidebar:"tutorialSidebar",previous:{title:"Burn",permalink:"/docs/build/wasm/from-zero-to-ink-hero/dex/Pair/burn"},next:{title:"Modifiers",permalink:"/docs/build/wasm/from-zero-to-ink-hero/dex/Pair/modifiers"}},c={},l=[{value:"1. Add Swap Functions to Pair Trait",id:"1-add-swap-functions-to-pair-trait",level:2},{value:"2. Swap",id:"2-swap",level:2},{value:"3. Implement Event",id:"3-implement-event",level:2}];function u(e){const n={a:"a",br:"br",code:"code",em:"em",h1:"h1",h2:"h2",p:"p",pre:"pre",strong:"strong",...(0,o.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"swap",children:"Swap"}),"\n",(0,t.jsxs)(n.p,{children:["If you are starting the tutorial from here, please check out this ",(0,t.jsx)(n.a,{href:"https://github.com/AstarNetwork/wasm-tutorial-dex/tree/tutorial/burn_end",children:"branch"})," and open it in your IDE."]}),"\n",(0,t.jsx)(n.h2,{id:"1-add-swap-functions-to-pair-trait",children:"1. Add Swap Functions to Pair Trait"}),"\n",(0,t.jsxs)(n.p,{children:["At this stage, we will implement a ",(0,t.jsx)(n.a,{href:"https://github.com/Uniswap/v2-core/blob/ee547b17853e71ed4e0101ccfd52e70d5acded58/contracts/UniswapV2Pair.sol#L159",children:"swap"})," function in the Pair contract.",(0,t.jsx)(n.br,{}),"\n",(0,t.jsx)(n.a,{href:"https://docs.uniswap.org/contracts/v2/concepts/core-concepts/swaps",children:"Swap"})," is a way for traders to exchange one PSP22 token for another one in a simple way.",(0,t.jsx)(n.br,{}),"\n","In the ",(0,t.jsx)(n.em,{children:"./logics/traits/pair.rs"})," file add the ",(0,t.jsx)(n.strong,{children:"swap"})," function to the Pair trait. As this function modifies the state, ",(0,t.jsx)(n.code,{children:"&mut self"})," should be used as the first argument.\nAlso, we will add a function to emit a swap event in the contract:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-rust",children:"pub trait Pair {\n    ...\n    #[ink(message)]\n    fn swap(\n        &mut self,\n        amount_0_out: Balance,\n        amount_1_out: Balance,\n        to: AccountId,\n    ) -> Result<(), PairError>;\n    ...\n    fn _emit_swap_event(\n        &self,\n        _sender: AccountId,\n        _amount_0_in: Balance,\n        _amount_1_in: Balance,\n        _amount_0_out: Balance,\n        _amount_1_out: Balance,\n        _to: AccountId,\n    );\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"2-swap",children:"2. Swap"}),"\n",(0,t.jsxs)(n.p,{children:["First, check user inputs, then ",(0,t.jsx)(n.em,{children:"get_reserves"})," and check liquidity:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-rust",children:"impl<T: Storage<data::Data> + Storage<psp22::Data>> Pair for T {\n    ...\n    fn swap(\n        &mut self,\n        amount_0_out: Balance,\n        amount_1_out: Balance,\n        to: AccountId,\n    ) -> Result<(), PairError> {\n        if amount_0_out == 0 && amount_1_out == 0 {\n            return Err(PairError::InsufficientOutputAmount)\n        }\n        let reserves = self.get_reserves();\n        if amount_0_out >= reserves.0 || amount_1_out >= reserves.1 {\n            return Err(PairError::InsufficientLiquidity)\n        }\n    }\n    ...\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Then, obtain the ",(0,t.jsx)(n.code,{children:"token_0"})," and ",(0,t.jsx)(n.code,{children:"token_1"})," addresses and process the swap. Ensure the amount transferred out is not ",(0,t.jsx)(n.code,{children:"0"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-rust",children:"...\n    let token_0 = self.data::<data::Data>().token_0;\n    let token_1 = self.data::<data::Data>().token_1;\n    \n    if to == token_0 || to == token_1 {\n    return Err(PairError::InvalidTo)\n    }\n    if amount_0_out > 0 {\n    self._safe_transfer(token_0, to, amount_0_out)?;\n    }\n    if amount_1_out > 0 {\n    self._safe_transfer(token_1, to, amount_1_out)?;\n    }\n...\n"})}),"\n",(0,t.jsx)(n.p,{children:"Then, obtain the balance of both token contracts, which will be used to update the price:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-rust",children:"...\n    let contract = Self::env().account_id();\n    let balance_0 = PSP22Ref::balance_of(&token_0, contract);\n    let balance_1 = PSP22Ref::balance_of(&token_1, contract);\n...\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Ensure that no swap attempted will leave the trading pair with less than the minimum amount of reserves.\n",(0,t.jsx)(n.code,{children:"balance_0"})," and ",(0,t.jsx)(n.code,{children:"balance_1"})," are the balances/reserves after the swap is finished, and ",(0,t.jsx)(n.code,{children:"reserve_0"})," and ",(0,t.jsx)(n.code,{children:"reserve_1"})," are the values previous to that (swap is done first and then possibly reverted, if the requirements are not met).\nWe will need to check that the swap did not reduce the product of the reserves (otherwise liquidity from the pool can be stolen).\nHence the reason why we check ",(0,t.jsx)(n.code,{children:"balance_0 * balance_1 >= reserve_0 * reserve_1"}),".",(0,t.jsx)(n.br,{}),"\n",(0,t.jsx)(n.code,{children:"balance_0_adjusted"})," and ",(0,t.jsx)(n.code,{children:"balance_1_adjusted"})," are adjusted with 0.3% swap ",(0,t.jsx)(n.a,{href:"https://docs.uniswap.org/contracts/v2/concepts/advanced-topics/fees#liquidity-provider-fees",children:"liquidity provider fees"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-rust",children:"...\n    let amount_0_in = if balance_0\n        > reserves\n        .0\n        .checked_sub(amount_0_out)\n        .ok_or(PairError::SubUnderFlow4)?\n    {\n        balance_0\n            .checked_sub(\n                reserves\n                    .0\n                    .checked_sub(amount_0_out)\n                    .ok_or(PairError::SubUnderFlow5)?,\n            )\n            .ok_or(PairError::SubUnderFlow6)?\n    } else {\n        0\n    };\n    let amount_1_in = if balance_1\n        > reserves\n        .1\n        .checked_sub(amount_1_out)\n        .ok_or(PairError::SubUnderFlow7)?\n    {\n        balance_1\n            .checked_sub(\n                reserves\n                    .1\n                    .checked_sub(amount_1_out)\n                    .ok_or(PairError::SubUnderFlow8)?,\n            )\n            .ok_or(PairError::SubUnderFlow9)?\n    } else {\n        0\n    };\n    if amount_0_in == 0 && amount_1_in == 0 {\n        return Err(PairError::InsufficientInputAmount)\n    }\n\n    let balance_0_adjusted = balance_0\n        .checked_mul(1000)\n        .ok_or(PairError::MulOverFlow8)?\n        .checked_sub(amount_0_in.checked_mul(3).ok_or(PairError::MulOverFlow9)?)\n        .ok_or(PairError::SubUnderFlow10)?;\n    let balance_1_adjusted = balance_1\n        .checked_mul(1000)\n        .ok_or(PairError::MulOverFlow10)?\n        .checked_sub(amount_1_in.checked_mul(3).ok_or(PairError::MulOverFlow11)?)\n        .ok_or(PairError::SubUnderFlow11)?;\n\n    if balance_0_adjusted\n        .checked_mul(balance_1_adjusted)\n        .ok_or(PairError::MulOverFlow16)?\n        < reserves\n        .0\n        .checked_mul(reserves.1)\n        .ok_or(PairError::MulOverFlow17)?\n        .checked_mul(1000u128.pow(2))\n        .ok_or(PairError::MulOverFlow18)?\n    {\n        return Err(PairError::K)\n    }\n"})}),"\n",(0,t.jsx)(n.p,{children:"Then update the pool reserves, and emit a swap event:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-rust",children:"        self._update(balance_0, balance_1, reserves.0, reserves.1)?;\n\n        self._emit_swap_event(\n            Self::env().caller(),\n            amount_0_in,\n            amount_1_in,\n            amount_0_out,\n            amount_1_out,\n            to,\n        );\n        Ok(())\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Add the empty implementation of ",(0,t.jsx)(n.strong,{children:"_emit_swap_event"}),". It should have the ",(0,t.jsx)(n.code,{children:"default"})," keyword, as we will override this function in the Pair contract:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-rust",children:"impl<T: Storage<data::Data> + Storage<psp22::Data>> Pair for T {\n    ...\n    default fn _emit_swap_event(\n        &self,\n        _sender: AccountId,\n        _amount_0_in: Balance,\n        _amount_1_in: Balance,\n        _amount_0_out: Balance,\n        _amount_1_out: Balance,\n        _to: AccountId,\n    ) {\n    }\n    ...\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Add the Error fields to ",(0,t.jsx)(n.code,{children:"PairError"})," in the ",(0,t.jsx)(n.em,{children:"./logics/traits/pair.rs"})," file:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-rust",children:'#[derive(Debug, PartialEq, Eq, scale::Encode, scale::Decode)]\n#[cfg_attr(feature = "std", derive(scale_info::TypeInfo))]\npub enum PairError {\n    PSP22Error(PSP22Error),\n    TransferError,\n    K,\n    InsufficientLiquidityMinted,\n    InsufficientLiquidityBurned,\n    InsufficientOutputAmount,\n    InsufficientLiquidity,\n    Overflow,\n    InvalidTo,\n    InsufficientInputAmount,\n    SubUnderFlow1,\n    SubUnderFlow2,\n    SubUnderFlow3,\n    SubUnderFlow4,\n    SubUnderFlow5,\n    SubUnderFlow6,\n    SubUnderFlow7,\n    SubUnderFlow8,\n    SubUnderFlow9,\n    SubUnderFlow10,\n    SubUnderFlow11,\n    SubUnderFlow14,\n    MulOverFlow1,\n    MulOverFlow2,\n    MulOverFlow3,\n    MulOverFlow4,\n    MulOverFlow5,\n    MulOverFlow6,\n    MulOverFlow7,\n    MulOverFlow8,\n    MulOverFlow9,\n    MulOverFlow10,\n    MulOverFlow11,\n    MulOverFlow14,\n    MulOverFlow15,\n    MulOverFlow16,\n    MulOverFlow17,\n    MulOverFlow18,\n    DivByZero1,\n    DivByZero2,\n    DivByZero3,\n    DivByZero4,\n    DivByZero5,\n    AddOverflow1,\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"3-implement-event",children:"3. Implement Event"}),"\n",(0,t.jsxs)(n.p,{children:["In the contracts ",(0,t.jsx)(n.em,{children:"./cotnracts/pair/lib.rs"})," file, add the Event struct and override the implementation of emit event:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-rust",children:"...\n#[ink(event)]\npub struct Swap {\n    #[ink(topic)]\n    pub sender: AccountId,\n    pub amount_0_in: Balance,\n    pub amount_1_in: Balance,\n    pub amount_0_out: Balance,\n    pub amount_1_out: Balance,\n    #[ink(topic)]\n    pub to: AccountId,\n}\n...\nimpl Pair for PairContract {\n    ...\n    fn _emit_swap_event(\n        &self,\n        sender: AccountId,\n        amount_0_in: Balance,\n        amount_1_in: Balance,\n        amount_0_out: Balance,\n        amount_1_out: Balance,\n        to: AccountId,\n    ) {\n        self.env().emit_event(Swap {\n            sender,\n            amount_0_in,\n            amount_1_in,\n            amount_0_out,\n            amount_1_out,\n            to,\n        })\n    }\n}\n...\n"})}),"\n",(0,t.jsx)(n.p,{children:"And that's it! Check your Pair contract with (run in contract folder):"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-console",children:"cargo contract build\n"})}),"\n",(0,t.jsxs)(n.p,{children:["It should now look like this ",(0,t.jsx)(n.a,{href:"https://github.com/AstarNetwork/wasm-tutorial-dex/tree/tutorial/swap_end",children:"branch"}),"."]})]})}function d(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(u,{...e})}):u(e)}},11151:(e,n,r)=>{r.d(n,{Z:()=>i,a:()=>s});var t=r(67294);const o={},a=t.createContext(o);function s(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);