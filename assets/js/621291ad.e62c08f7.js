"use strict";(self.webpackChunkdocs_1=self.webpackChunkdocs_1||[]).push([[5237],{16720:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>l});var i=t(85893),c=t(11151);const a={sidebar_position:4},r="ManicMinter e2e Test",s={id:"build/wasm/from-zero-to-ink-hero/manic-minter/manic-e2e",title:"ManicMinter e2e Test",description:"In this chapter we will write e2e tests for the ManicMinter contract. The e2e tests will be written in Rust using the ink! e2e framework. The e2e tests will be executed on a local substrate node.",source:"@site/docs/build/wasm/from-zero-to-ink-hero/manic-minter/manic-e2e.md",sourceDirName:"build/wasm/from-zero-to-ink-hero/manic-minter",slug:"/build/wasm/from-zero-to-ink-hero/manic-minter/manic-e2e",permalink:"/docs/build/wasm/from-zero-to-ink-hero/manic-minter/manic-e2e",draft:!1,unlisted:!1,editUrl:"https://github.com/AstarNetwork/astar-docs/tree/main/docs/build/wasm/from-zero-to-ink-hero/manic-minter/manic-e2e.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"ManicMinter Contract",permalink:"/docs/build/wasm/from-zero-to-ink-hero/manic-minter/manic-contract"},next:{title:"Overview",permalink:"/docs/build/wasm/from-zero-to-ink-hero/dex/"}},o={},l=[{value:"Import Crates",id:"import-crates",level:2},{value:"Instantiate Contracts",id:"instantiate-contracts",level:2},{value:"Set ManicMinter as Owner of Oxygen",id:"set-manicminter-as-owner-of-oxygen",level:2},{value:"Set Price for Oxygen Tokens",id:"set-price-for-oxygen-tokens",level:2},{value:"Mint Oxygen Tokens",id:"mint-oxygen-tokens",level:2},{value:"Execute e2e Test",id:"execute-e2e-test",level:2},{value:"Debugging e2e Test",id:"debugging-e2e-test",level:2},{value:"Summary of the e2e Test Chapter:",id:"summary-of-the-e2e-test-chapter",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,c.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"manicminter-e2e-test",children:"ManicMinter e2e Test"}),"\n",(0,i.jsx)(n.p,{children:"In this chapter we will write e2e tests for the ManicMinter contract. The e2e tests will be written in Rust using the ink! e2e framework. The e2e tests will be executed on a local substrate node.\nJust like in previous chapter we will not include complete code from the contract to keep it short and focused on the e2e tests."}),"\n",(0,i.jsx)(n.h2,{id:"import-crates",children:"Import Crates"}),"\n",(0,i.jsxs)(n.p,{children:["Let's create a new module ",(0,i.jsx)(n.code,{children:"e2e_tests"})," within the body of the ",(0,i.jsx)(n.code,{children:"mod manicminter"})," and import the following crates:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rust",children:'#[cfg(all(test, feature = "e2e-tests"))]\nmod e2e_tests {\n    use super::*;\n    use crate::manicminter::ManicMinterRef;\n    use ink::primitives::AccountId;\n    use ink_e2e::build_message;\n    use openbrush::contracts::ownable::ownable_external::Ownable;\n    use openbrush::contracts::psp22::psp22_external::PSP22;\n    use oxygen::oxygen::OxygenRef;\n\n    type E2EResult<T> = std::result::Result<T, Box<dyn std::error::Error>>;\n\n    const AMOUNT: Balance = 100;\n    const PRICE: Balance = 10;\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"You will notice that we import Openbrush traits to invoke methods from the Oxygen contract, which is implemented using Openbrush's version of PSP22."}),"\n",(0,i.jsx)(n.h2,{id:"instantiate-contracts",children:"Instantiate Contracts"}),"\n",(0,i.jsxs)(n.p,{children:["We will use the ",(0,i.jsx)(n.code,{children:"ink_e2e::Client"})," to instantiate the contracts. The ",(0,i.jsx)(n.code,{children:"ink_e2e::Client"})," is a wrapper around the ",(0,i.jsx)(n.code,{children:"ink_env::test"})," environment. The ",(0,i.jsx)(n.code,{children:"ink_e2e::Client"})," provides a convenient way to instantiate contracts and invoke contract methods."]}),"\n",(0,i.jsxs)(n.p,{children:["In the declarative macro add our contracts as ",(0,i.jsx)(n.code,{children:"additional contracts"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rust",children:'#[ink_e2e::test(additional_contracts = "manicminter/Cargo.toml oxygen/Cargo.toml")]\nasync fn e2e_minting_works(mut client: ink_e2e::Client<C, E>) -> E2EResult<()> {\n    let initial_balance: Balance = 1_000_000;\n\n    // Instantiate Oxygen contract\n    let token_constructor = OxygenRef::new(initial_balance);\n    let oxygen_account_id = client\n        .instantiate("oxygen", &ink_e2e::alice(), token_constructor, 0, None)\n        .await\n        .expect("token instantiate failed")\n        .account_id;\n\n    // Instantiate ManicMinter contract\n    let manic_minter_constructor = ManicMinterRef::new(oxygen_account_id);\n    let manic_minter_account_id = client\n        .instantiate(\n            "manic-minter",\n            &ink_e2e::alice(),\n            manic_minter_constructor,\n            0,\n            None,\n        )\n        .await\n        .expect("ManicMinter instantiate failed")\n        .account_id;\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"set-manicminter-as-owner-of-oxygen",children:"Set ManicMinter as Owner of Oxygen"}),"\n",(0,i.jsxs)(n.p,{children:["We will use the ",(0,i.jsx)(n.code,{children:"build_message"})," macro to compose the ",(0,i.jsx)(n.code,{children:"transfer_ownership"})," method of the Oxygen contract. The ",(0,i.jsx)(n.code,{children:"client.call()"})," executes the contract call. The ",(0,i.jsx)(n.code,{children:"call_dry_run"})," method with ",(0,i.jsx)(n.code,{children:"owner()"})," message verifies the result of the contract call."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rust",children:'// Set ManicMinter contract to be the owner of Oxygen contract\nlet change_owner = build_message::<OxygenRef>(oxygen_account_id.clone())\n    .call(|p| p.transfer_ownership(manic_minter_account_id));\nclient\n    .call(&ink_e2e::alice(), change_owner, 0, None)\n    .await\n    .expect("calling `transfer_ownership` failed");\n\n// Verify that ManicMinter is the Oxygen contract owner\nlet owner = build_message::<OxygenRef>(oxygen_account_id.clone()).call(|p| p.owner());\nlet owner_result = client\n    .call_dry_run(&ink_e2e::alice(), &owner, 0, None)\n    .await\n    .return_value();\nassert_eq!(owner_result, manic_minter_account_id);\n'})}),"\n",(0,i.jsx)(n.h2,{id:"set-price-for-oxygen-tokens",children:"Set Price for Oxygen Tokens"}),"\n",(0,i.jsxs)(n.p,{children:["We  use the ",(0,i.jsx)(n.code,{children:"build_message"})," macro to compose the ",(0,i.jsx)(n.code,{children:"set_price"})," method of the ManicMinter contract. The ",(0,i.jsx)(n.code,{children:"client.call()"})," executes the contract call."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rust",children:'// Contract owner sets price\nlet price_message = build_message::<ManicMinterRef>(manic_minter_account_id.clone())\n    .call(|manicminter| manicminter.set_price(PRICE));\nclient\n    .call(&ink_e2e::alice(), price_message, 0, None)\n    .await\n    .expect("calling `set_price` failed");\n\n'})}),"\n",(0,i.jsx)(n.h2,{id:"mint-oxygen-tokens",children:"Mint Oxygen Tokens"}),"\n",(0,i.jsxs)(n.p,{children:["We are now ready to execute ",(0,i.jsx)(n.code,{children:"manic_mint"})," method of the ManicMinter contract. We use the ",(0,i.jsx)(n.code,{children:"build_message"})," macro to compose the ",(0,i.jsx)(n.code,{children:"manic_mint"})," method of the ManicMinter contract. The ",(0,i.jsx)(n.code,{children:"client.call()"})," executes the contract call. The ",(0,i.jsx)(n.code,{children:"call_dry_run"})," method with ",(0,i.jsx)(n.code,{children:"balance_of()"})," message verifies the result of the contract call on the Oxygen contract."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rust",children:'// Bob mints AMOUNT of Oxygen tokens by calling ManicMinter contract\nlet mint_message = build_message::<ManicMinterRef>(manic_minter_account_id.clone())\n    .call(|manicminter| manicminter.manic_mint(AMOUNT));\nclient\n    .call(&ink_e2e::bob(), mint_message, PRICE * AMOUNT, None)\n    .await\n    .expect("calling `pink_mint` failed");\n\n// Verify that tokens were minted on Oxygen contract\nlet bob_account_id = get_bob_account_id();\nlet balance_message = build_message::<OxygenRef>(oxygen_account_id.clone())\n    .call(|p| p.balance_of(bob_account_id));\nlet token_balance = client\n    .call_dry_run(&ink_e2e::bob(), &balance_message, 0, None)\n    .await\n    .return_value();\nassert_eq!(token_balance, AMOUNT);\n'})}),"\n",(0,i.jsx)(n.h2,{id:"execute-e2e-test",children:"Execute e2e Test"}),"\n",(0,i.jsxs)(n.p,{children:["The e2e tests are invoking the node which is running on the local machine.\nBefore running the test we need to setup the environment variable ",(0,i.jsx)(n.code,{children:"CONTRACT_NODE"})," to the executable local node. The node can be Swanky-node or any other node that implements pallet-contracts."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'export CONTRACTS_NODE="YOUR_CONTRACTS_NODE_PATH"\n'})}),"\n",(0,i.jsx)(n.p,{children:"As an example it can be set to the following value:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'export CONTRACTS_NODE="/home/p/Documents/astar/target/release/astar-collator"\n'})}),"\n",(0,i.jsx)(n.p,{children:"After setting your node path, run the following command to execute the e2e tests:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cargo test --features e2e-tests\n"})}),"\n",(0,i.jsx)(n.h2,{id:"debugging-e2e-test",children:"Debugging e2e Test"}),"\n",(0,i.jsxs)(n.p,{children:["If you want to print some variables and messages during the e2e test execution you can use the ",(0,i.jsx)(n.code,{children:"println!"})," macro. The output will be printed in the terminal where the test is executed. To be able to see the printed output you need to run the test with ",(0,i.jsx)(n.code,{children:"--nocapture"})," flag:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cargo test --features e2e-tests -- --nocapture\n"})}),"\n",(0,i.jsx)(n.h2,{id:"summary-of-the-e2e-test-chapter",children:"Summary of the e2e Test Chapter:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"We imported the required crates for e2e tests."}),"\n",(0,i.jsx)(n.li,{children:"We instantiated the ManicMinter and Oxygen contracts."}),"\n",(0,i.jsx)(n.li,{children:"We set the ManicMinter contract to be the owner of the Oxygen contract."}),"\n",(0,i.jsx)(n.li,{children:"We set the price for Oxygen tokens."}),"\n",(0,i.jsx)(n.li,{children:"We minted Oxygen tokens using the ManicMinter contract."}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The full code for this example is available ",(0,i.jsx)(n.a,{href:"https://github.com/swanky-dapps/manic-minter",children:"here"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,c.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},11151:(e,n,t)=>{t.d(n,{Z:()=>s,a:()=>r});var i=t(67294);const c={},a=i.createContext(c);function r(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:r(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);